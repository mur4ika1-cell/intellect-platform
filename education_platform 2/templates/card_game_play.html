{% extends "base.html" %}

{% block title %}–ò–≥—Ä–∞ - {{ session.title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>üéÆ {{ session.title }}</h2>
            <p class="text-muted">{{ session.topic }}</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('view_card_game_session', session_id=session.id) }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> –ö —Å–µ—Å—Å–∏–∏
            </a>
        </div>
    </div>

    <div class="row">
        <!-- –ú–æ–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ (–æ—Ç–≤–µ—á–∞—é) -->
        <div class="col-lg-6 mb-4">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-pencil-alt"></i> –ú–æ–∏ –≤–æ–ø—Ä–æ—Å—ã ({{ my_cards|length }})
                    </h5>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    {% if my_cards %}
                        {% for card in my_cards %}
                        <div class="card mb-3 {% if card.answers|length > 0 %}border-success{% endif %}">
                            <div class="card-body">
                                <h6 class="card-title">–í–æ–ø—Ä–æ—Å {{ loop.index }}</h6>
                                <p class="card-text"><strong>{{ card.question }}</strong></p>
                                
                                {% set my_answer = card.answers|selectattr('user_id', 'equalto', current_user.id)|first %}
                                
                                {% if my_answer %}
                                    <div class="alert alert-success">
                                        <strong>–í–∞—à –æ—Ç–≤–µ—Ç:</strong> {{ my_answer.answer_text }}
                                        {% if my_answer.checked_at %}
                                            <hr>
                                            <strong>–û—Ü–µ–Ω–∫–∞:</strong> 
                                            {% for i in range(my_answer.rating) %}
                                                <i class="fas fa-star text-warning"></i>
                                            {% endfor %}
                                            {% if my_answer.feedback %}
                                                <br><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> {{ my_answer.feedback }}
                                            {% endif %}
                                        {% else %}
                                            <br><em class="text-muted">–û–∂–∏–¥–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏...</em>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <form onsubmit="submitAnswer(event, {{ card.id }})">
                                        <div class="mb-3">
                                            <label class="form-label">–í–∞—à –æ—Ç–≤–µ—Ç:</label>
                                            <textarea class="form-control" rows="3" required 
                                                      placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç –∑–¥–µ—Å—å..."
                                                      id="answer-{{ card.id }}"></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary btn-sm">
                                            <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç
                                        </button>
                                    </form>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center py-4">–£ –≤–∞—Å –Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è –æ—Ç–≤–µ—Ç–∞</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ -->
        <div class="col-lg-6 mb-4">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-check-circle"></i> –ü—Ä–æ–≤–µ—Ä—è—é —Ç–æ–≤–∞—Ä–∏—â–µ–π ({{ checking_cards|length }})
                    </h5>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    {% if checking_cards %}
                        {% for card in checking_cards %}
                        <div class="card mb-3">
                            <div class="card-body">
                                <h6 class="card-title">
                                    –ö–∞—Ä—Ç–æ—á–∫–∞ {{ loop.index }} 
                                    <small class="text-muted">
                                        (–æ—Ç–≤–µ—á–∞–µ—Ç: {{ card.assigned_to.nickname or card.assigned_to.username }})
                                    </small>
                                </h6>
                                
                                <!-- –í–æ–ø—Ä–æ—Å -->
                                <div class="alert alert-info">
                                    <strong>–í–æ–ø—Ä–æ—Å:</strong> {{ card.question }}
                                </div>
                                
                                <!-- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç -->
                                <div class="alert alert-success">
                                    <strong><i class="fas fa-check"></i> –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</strong> {{ card.answer }}
                                    {% if card.explanation %}
                                        <hr>
                                        <small><strong>–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:</strong> {{ card.explanation }}</small>
                                    {% endif %}
                                </div>
                                
                                <!-- –û—Ç–≤–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–∞ -->
                                {% set student_answer = card.answers|selectattr('user_id', 'equalto', card.assigned_to_user_id)|first %}
                                
                                {% if student_answer %}
                                    <div class="alert alert-light border">
                                        <strong>–û—Ç–≤–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–∞:</strong> {{ student_answer.answer_text }}
                                    </div>
                                    
                                    {% if student_answer.checked_at %}
                                        <div class="alert alert-secondary">
                                            <strong>–í—ã —É–∂–µ –ø—Ä–æ–≤–µ—Ä–∏–ª–∏:</strong>
                                            {% for i in range(student_answer.rating) %}
                                                <i class="fas fa-star text-warning"></i>
                                            {% endfor %}
                                            {% if student_answer.is_correct %}
                                                <span class="badge bg-success">–ü—Ä–∞–≤–∏–ª—å–Ω–æ</span>
                                            {% else %}
                                                <span class="badge bg-danger">–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ</span>
                                            {% endif %}
                                            {% if student_answer.feedback %}
                                                <br><strong>–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> {{ student_answer.feedback }}
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <form onsubmit="submitRating(event, {{ student_answer.id }})">
                                            <div class="mb-3">
                                                <label class="form-label">–û—Ü–µ–Ω–∫–∞ (1-5 –∑–≤—ë–∑–¥):</label>
                                                <div class="btn-group" role="group">
                                                    {% for i in range(1, 6) %}
                                                    <input type="radio" class="btn-check" name="rating-{{ student_answer.id }}" 
                                                           id="rating-{{ student_answer.id }}-{{ i }}" value="{{ i }}" required>
                                                    <label class="btn btn-outline-warning" for="rating-{{ student_answer.id }}-{{ i }}">
                                                        {{ i }} <i class="fas fa-star"></i>
                                                    </label>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">–ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å:</label>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" 
                                                           name="correct-{{ student_answer.id }}" 
                                                           id="correct-yes-{{ student_answer.id }}" 
                                                           value="true" required>
                                                    <label class="form-check-label" for="correct-yes-{{ student_answer.id }}">
                                                        ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" 
                                                           name="correct-{{ student_answer.id }}" 
                                                           id="correct-no-{{ student_answer.id }}" 
                                                           value="false">
                                                    <label class="form-check-label" for="correct-no-{{ student_answer.id }}">
                                                        ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                                                <textarea class="form-control" rows="2" 
                                                          id="feedback-{{ student_answer.id }}"
                                                          placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
                                            </div>
                                            
                                            <button type="submit" class="btn btn-success btn-sm">
                                                <i class="fas fa-check"></i> –û—Ü–µ–Ω–∏—Ç—å
                                            </button>
                                        </form>
                                    {% endif %}
                                {% else %}
                                    <div class="alert alert-warning">
                                        <i class="fas fa-clock"></i> –°—Ç—É–¥–µ–Ω—Ç –µ—â–µ –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center py-4">–£ –≤–∞—Å –Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function submitAnswer(event, cardId) {
    event.preventDefault();
    
    const answerText = document.getElementById(`answer-${cardId}`).value.trim();
    if (!answerText) {
        alert('–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç!');
        return;
    }
    
    fetch(`/api/card-game/card/${cardId}/answer`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({answer_text: answerText})
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert('–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
        }
    })
    .catch(err => alert('–û—à–∏–±–∫–∞: ' + err));
}

function submitRating(event, answerId) {
    event.preventDefault();
    
    const rating = document.querySelector(`input[name="rating-${answerId}"]:checked`);
    const isCorrect = document.querySelector(`input[name="correct-${answerId}"]:checked`);
    const feedback = document.getElementById(`feedback-${answerId}`).value.trim();
    
    if (!rating || !isCorrect) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!');
        return;
    }
    
    fetch(`/api/card-game/answer/${answerId}/rate`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            rating: parseInt(rating.value),
            is_correct: isCorrect.value === 'true',
            feedback: feedback
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert('–û—Ü–µ–Ω–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
        }
    })
    .catch(err => alert('–û—à–∏–±–∫–∞: ' + err));
}
</script>
{% endblock %}
